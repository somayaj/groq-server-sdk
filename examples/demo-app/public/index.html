<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Groq AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['DM Sans', 'system-ui', 'sans-serif'],
          },
          colors: {
            midnight: {
              50: '#f0f4f8',
              100: '#d9e2ec',
              200: '#bcccdc',
              300: '#9fb3c8',
              400: '#829ab1',
              500: '#627d98',
              600: '#486581',
              700: '#334e68',
              800: '#243b53',
              900: '#102a43',
              950: '#0a1929',
            },
            groq: {
              400: '#f97316',
              500: '#ea580c',
              600: '#c2410c',
            }
          }
        }
      }
    }
  </script>
  <style>
    .typing-indicator span {
      animation: blink 1.4s infinite both;
    }
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes blink {
      0%, 60%, 100% { opacity: 0.2; }
      30% { opacity: 1; }
    }
    .message-fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .gradient-border {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 50%, #dc2626 100%);
    }
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: #486581;
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #627d98;
    }
    .prose pre {
      background: #1e293b;
      border-radius: 8px;
      padding: 1rem;
      overflow-x: auto;
    }
    .prose code {
      background: #334e68;
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-size: 0.875em;
    }
    .prose pre code {
      background: transparent;
      padding: 0;
    }
  </style>
</head>
<body class="h-full bg-midnight-950 text-gray-100 font-sans antialiased">
  <div class="flex flex-col h-full max-w-5xl mx-auto">
    
    <!-- Header -->
    <header class="flex-shrink-0 border-b border-midnight-800/50 backdrop-blur-sm bg-midnight-950/80 sticky top-0 z-10">
      <div class="px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl gradient-border flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
          </div>
          <div>
            <h1 class="text-lg font-semibold text-white">Groq Chat</h1>
            <p class="text-xs text-midnight-400">Powered by Llama 3.3 70B</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="status-indicator" class="flex items-center gap-2 text-sm text-midnight-400">
            <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
            Connected
          </span>
          <button onclick="clearConversation()" class="ml-4 p-2 rounded-lg hover:bg-midnight-800 transition-colors text-midnight-400 hover:text-white" title="New conversation">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Chat Messages -->
    <main id="chat-container" class="flex-1 overflow-y-auto px-4 py-6 space-y-6">
      
      <!-- Welcome Message -->
      <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-center px-4">
        <div class="w-20 h-20 rounded-2xl gradient-border flex items-center justify-center mb-6">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
        </div>
        <h2 class="text-2xl font-semibold text-white mb-2">Lightning-Fast AI</h2>
        <p class="text-midnight-400 max-w-md mb-8">Experience blazing-fast responses powered by Groq's LPU inference engine and Llama 3.3.</p>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-lg">
          <button onclick="sendSuggestion('Explain quantum computing in simple terms')" class="p-4 rounded-xl bg-midnight-900/50 border border-midnight-800 hover:border-groq-500/50 hover:bg-midnight-800/50 transition-all text-left group">
            <div class="flex items-start gap-3">
              <span class="text-xl">ðŸ’¡</span>
              <span class="text-sm text-midnight-300 group-hover:text-white transition-colors">Explain quantum computing in simple terms</span>
            </div>
          </button>
          <button onclick="sendSuggestion('Write a Python function to sort a list')" class="p-4 rounded-xl bg-midnight-900/50 border border-midnight-800 hover:border-groq-500/50 hover:bg-midnight-800/50 transition-all text-left group">
            <div class="flex items-start gap-3">
              <span class="text-xl">ðŸ’»</span>
              <span class="text-sm text-midnight-300 group-hover:text-white transition-colors">Write a Python function to sort a list</span>
            </div>
          </button>
          <button onclick="sendSuggestion('What are the best practices for REST API design?')" class="p-4 rounded-xl bg-midnight-900/50 border border-midnight-800 hover:border-groq-500/50 hover:bg-midnight-800/50 transition-all text-left group">
            <div class="flex items-start gap-3">
              <span class="text-xl">ðŸ”§</span>
              <span class="text-sm text-midnight-300 group-hover:text-white transition-colors">Best practices for REST API design</span>
            </div>
          </button>
          <button onclick="sendSuggestion('Help me brainstorm ideas for a mobile app')" class="p-4 rounded-xl bg-midnight-900/50 border border-midnight-800 hover:border-groq-500/50 hover:bg-midnight-800/50 transition-all text-left group">
            <div class="flex items-start gap-3">
              <span class="text-xl">ðŸš€</span>
              <span class="text-sm text-midnight-300 group-hover:text-white transition-colors">Brainstorm mobile app ideas</span>
            </div>
          </button>
        </div>
      </div>

      <!-- Messages will be inserted here -->
      <div id="messages"></div>
      
      <!-- Typing Indicator -->
      <div id="typing-indicator" class="hidden flex gap-4 message-fade-in">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-groq-400 to-red-500 flex-shrink-0 flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
        </div>
        <div class="bg-midnight-900/50 border border-midnight-800 rounded-2xl rounded-tl-md px-4 py-3">
          <div class="typing-indicator flex gap-1">
            <span class="w-2 h-2 rounded-full bg-midnight-400"></span>
            <span class="w-2 h-2 rounded-full bg-midnight-400"></span>
            <span class="w-2 h-2 rounded-full bg-midnight-400"></span>
          </div>
        </div>
      </div>
    </main>

    <!-- Input Area -->
    <footer class="flex-shrink-0 border-t border-midnight-800/50 bg-midnight-950/80 backdrop-blur-sm p-4">
      <form id="chat-form" class="flex gap-3 items-end max-w-4xl mx-auto">
        <div class="flex-1 relative">
          <textarea 
            id="message-input" 
            placeholder="Type your message..." 
            rows="1"
            class="w-full resize-none rounded-xl bg-midnight-900/50 border border-midnight-700 focus:border-groq-500 focus:ring-1 focus:ring-groq-500/50 px-4 py-3 pr-12 text-white placeholder-midnight-500 transition-all outline-none max-h-32"
            onkeydown="handleKeyDown(event)"
            oninput="autoResize(this)"
          ></textarea>
        </div>
        <button 
          type="submit" 
          id="send-button"
          class="flex-shrink-0 w-12 h-12 rounded-xl bg-groq-500 hover:bg-groq-600 disabled:bg-midnight-700 disabled:cursor-not-allowed flex items-center justify-center transition-all shadow-lg shadow-groq-500/25 hover:shadow-groq-500/40 disabled:shadow-none"
        >
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
        </button>
      </form>
      <p class="text-center text-xs text-midnight-600 mt-3">Powered by Groq LPUâ„¢ Inference Engine â€¢ Blazing fast AI responses</p>
    </footer>
  </div>

  <script>
    // State
    let conversationId = null;
    let isStreaming = false;
    let ws = null;

    // DOM Elements
    const chatContainer = document.getElementById('chat-container');
    const messagesContainer = document.getElementById('messages');
    const welcomeMessage = document.getElementById('welcome-message');
    const typingIndicator = document.getElementById('typing-indicator');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const statusIndicator = document.getElementById('status-indicator');

    // Initialize WebSocket connection
    function initWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

      ws.onopen = () => {
        updateStatus('Connected', true);
      };

      ws.onclose = () => {
        updateStatus('Disconnected', false);
        // Attempt to reconnect after 3 seconds
        setTimeout(initWebSocket, 3000);
      };

      ws.onerror = () => {
        updateStatus('Connection error', false);
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
      };
    }

    function updateStatus(text, connected) {
      statusIndicator.innerHTML = `
        <span class="w-2 h-2 rounded-full ${connected ? 'bg-emerald-500 animate-pulse' : 'bg-red-500'}"></span>
        ${text}
      `;
    }

    function handleWebSocketMessage(data) {
      switch (data.type) {
        case 'connected':
          conversationId = data.sessionId;
          break;
        case 'start':
          hideTypingIndicator();
          addMessage('assistant', '', true);
          break;
        case 'chunk':
          if (data.content) {
            appendToLastMessage(data.content);
          }
          break;
        case 'end':
          isStreaming = false;
          enableInput();
          scrollToBottom();
          break;
        case 'error':
          hideTypingIndicator();
          addMessage('assistant', `Error: ${data.error}`);
          isStreaming = false;
          enableInput();
          break;
      }
    }

    // Form submission
    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      sendMessage();
    });

    function sendMessage() {
      const message = messageInput.value.trim();
      if (!message || isStreaming) return;

      // Hide welcome message
      welcomeMessage.classList.add('hidden');

      // Add user message
      addMessage('user', message);
      messageInput.value = '';
      autoResize(messageInput);

      // Show typing indicator
      showTypingIndicator();
      disableInput();
      isStreaming = true;

      // Send via WebSocket
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'chat',
          message: message
        }));
      } else {
        // Fallback to REST API with streaming
        sendViaREST(message);
      }
    }

    async function sendViaREST(message) {
      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            conversationId,
            stream: true
          })
        });

        hideTypingIndicator();
        addMessage('assistant', '', true);

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                if (data.content) {
                  appendToLastMessage(data.content);
                }
                if (data.conversationId) {
                  conversationId = data.conversationId;
                }
              } catch (e) {}
            }
          }
        }
      } catch (error) {
        hideTypingIndicator();
        addMessage('assistant', 'Sorry, there was an error processing your request.');
      } finally {
        isStreaming = false;
        enableInput();
      }
    }

    function addMessage(role, content, streaming = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex gap-4 message-fade-in ${role === 'user' ? 'flex-row-reverse' : ''}`;
      
      const avatar = role === 'user' 
        ? `<div class="w-8 h-8 rounded-lg bg-midnight-700 flex-shrink-0 flex items-center justify-center">
            <svg class="w-4 h-4 text-midnight-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>`
        : `<div class="w-8 h-8 rounded-lg bg-gradient-to-br from-groq-400 to-red-500 flex-shrink-0 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
          </div>`;

      const bubbleClass = role === 'user'
        ? 'bg-groq-500/20 border-groq-500/30 rounded-2xl rounded-tr-md'
        : 'bg-midnight-900/50 border-midnight-800 rounded-2xl rounded-tl-md';

      messageDiv.innerHTML = `
        ${avatar}
        <div class="max-w-[80%] ${bubbleClass} border px-4 py-3">
          <div class="prose prose-invert prose-sm max-w-none message-content ${streaming ? 'streaming' : ''}">${formatMessage(content)}</div>
        </div>
      `;

      messagesContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    function appendToLastMessage(content) {
      const lastContent = messagesContainer.querySelector('.message-content.streaming');
      if (lastContent) {
        lastContent.textContent += content;
        scrollToBottom();
      }
    }

    function formatMessage(content) {
      // Basic markdown-like formatting
      return content
        .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
    }

    function showTypingIndicator() {
      typingIndicator.classList.remove('hidden');
      scrollToBottom();
    }

    function hideTypingIndicator() {
      typingIndicator.classList.add('hidden');
    }

    function enableInput() {
      messageInput.disabled = false;
      sendButton.disabled = false;
      messageInput.focus();
    }

    function disableInput() {
      messageInput.disabled = true;
      sendButton.disabled = true;
    }

    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function sendSuggestion(text) {
      messageInput.value = text;
      sendMessage();
    }

    function clearConversation() {
      messagesContainer.innerHTML = '';
      welcomeMessage.classList.remove('hidden');
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'clear' }));
      }
      
      conversationId = null;
    }

    // Initialize
    initWebSocket();
    messageInput.focus();
  </script>
</body>
</html>
